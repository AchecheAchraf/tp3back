<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Produits vendus par catégorie</title>
	<meta charset="UTF-8" />
	<link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" href="../static/css/style.css" />
	<!-- On charge JQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!-- On charge l'API Google -->
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript">
		// cf. https://developers.google.com/chart/interactive/docs/gallery/piechart
		google.charts.load('current', { 'packages': ['corechart'] });

		// On fait l'appel AJAX dès le chargement de la page
		google.charts.setOnLoadCallback(doAjax);

		// Fait un appel AJAX pour récupérer les données à afficher
		function doAjax() {
			$.ajax({
				// On appelle le service qui renvoie le résultat comme un tableau de valeurs
				url: "/api/stats/unitesVenduesPourCategorieV2",
				// On passe comme paramètre les données saisies dans le formulaire
				data: $('#formulaireCategorie').serialize(),
				// On demande du JSON comme résultat
				dataType: "json",
				success: drawPiechart, // La fonction qui traite les résultats
				error: showError
			});
		}

		// Affiche le résultat des statistiques sous forme de camembert
		function drawPiechart(result) {
			// On met le résultat au format attendu par google
			// En-têtes des colonnes
			var headers = ['Produit', 'Unités vendues'];
			// cf. https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Array/unshift
			result.unshift(headers);

			var dataTable = google.visualization.arrayToDataTable(result);
			var chart = new google.visualization.PieChart(document.getElementById('piechart'));
			var options = { title: 'Unités vendues par produit' };
			chart.draw(dataTable, options);
		}

		// Fonction qui traite les erreurs de la requête
		function showError(xhr, status, message) {
			alert("Erreur: " + status + " : " + message);
		}

	</script>
</head>

<body>
	<h1>Produits vendus pour une catégorie</h1>
	<h2>Illustre le passage de paramètres dans un appel AJAX</h2>
	<!--/* Un formulaire pour choisir la catégorie à afficher */-->
	<!--/* On pourrait également faire un appel AJAX pour aller chercher la liste des catégories */-->
	<form id="formulaireCategorie">
		<!--/* On choisit le code de la catégorie sur laquelle doit porter la statistique */-->
		<!--/* Chaque fois qu'on choisit un code, on fait l'appel AJAX */-->
		<select name='code' onchange='doAjax()'>
			<!--/* Une option pour chaque catégorie c dans la liste 'categories' transmise par le contrôleur */-->
			<option th:each="c: ${categories}" th:value='${c.code}' value="1" th:text="${c.libelle}">
				Le libellé de la catégorie
			</option>
		</select>
		<!--/* Pas de 'submit', on fait un appel AJAX */-->
	</form><br />
	<a th:href="@{/api/stats/unitesVenduesPourCategorieV2?code=1}" target="_blank" href="#">Résultats fournis par
		l'appel AJAX</a>
	<!-- Le graphique apparaît ici -->
	<div id="piechart" style="width: 1000px; height: 500px;"></div>
	<hr />
	<a th:href="@{/}" href="../static/index.html">Retour au menu</a>
</body>

</html>